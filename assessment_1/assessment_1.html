<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Student number: 23083053">

<title>Agent-Based Modelling Assessment 1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="assessment_1_files/libs/clipboard/clipboard.min.js"></script>
<script src="assessment_1_files/libs/quarto-html/quarto.js"></script>
<script src="assessment_1_files/libs/quarto-html/popper.min.js"></script>
<script src="assessment_1_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="assessment_1_files/libs/quarto-html/anchor.min.js"></script>
<link href="assessment_1_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="assessment_1_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="assessment_1_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="assessment_1_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="assessment_1_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="..\assessment_1.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Agent-Based Modelling Assessment 1</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Student number: 23083053 </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="aim" class="level2">
<h2 class="anchored" data-anchor-id="aim">Aim</h2>
<p>This report aims to investigate the impact of various factors on the wealth distribution and the survival rate of turtles in the sugarscape model. In this report, the following 2 models from the NetLogo Models Library are investigated and compared.</p>
<ul>
<li>Sugarscape 2 Constant Growback model <span class="citation" data-cites="li2009">(<a href="#ref-li2009" role="doc-biblioref">Li and Wilensky, 2009a</a>)</span></li>
<li>Sugarscape 3 Wealth Distribution model <span class="citation" data-cites="li2009a">(<a href="#ref-li2009a" role="doc-biblioref">Li and Wilensky, 2009b</a>)</span></li>
</ul>
<p>The differences between the 2 models is that the Sugarscape 3 model introduces reproduction and replacement, where turtles who have reached a certain age will die, and dead turtles are replaced by a new turtle placed in a random position. The Sugarscape 2 model can be interpreted as a representation of one generation of turtles, where the Sugarscape 3 model simulates multiple generations.</p>
<section id="research-question" class="level3">
<h3 class="anchored" data-anchor-id="research-question">Research Question</h3>
<p>How will the survival rate and the Gini Index change according to population growth? Is there a difference in the survival rate and the Gini Index when considering reproduction?</p>
</section>
<section id="hypothesis" class="level3">
<h3 class="anchored" data-anchor-id="hypothesis">Hypothesis</h3>
<p>The increase in population is expected to lower the survival rate and increase the Gini Index due to intesifying competition. The wealth distribution among turtles are expected to even out when considering reproduction. Turtles being ‘stuck’ to different areas with different amount of sugar may be the cause of inequality, and the reproduction process introduces more fluidness to the system.</p>
</section>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<p>We modified the Sugarscape Models in the NetLogo Models Library to change constants on the interface and the BehaviourSpace tool on NetLogo <span class="citation" data-cites="epstein1996a">(<a href="#ref-epstein1996a" role="doc-biblioref">Epstein and Axtell, 1996</a>)</span> to report the performance of each model. Further investigation on the wealth distribution was conducted to identify the mechanism behind the observed phenomenon.</p>
<section id="changing-variables-and-iterations" class="level3">
<h3 class="anchored" data-anchor-id="changing-variables-and-iterations">Changing Variables and Iterations</h3>
<p>Using the BehaviorSpace tool, we have simulated the performance using variables shown in <a href="#tbl-variable">Table&nbsp;1</a> for both Sugarscape 2 and 3 models. All variations of the model were repeated 20 times. All other variables were unchanged from the original state.</p>
<div id="tbl-variable" class="anchored">
<table class="table">
<caption>Table&nbsp;1: The variables and the range considered in this report</caption>
<colgroup>
<col style="width: 30%">
<col style="width: 40%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Explanation</th>
<th>Experimented Values</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>initial_population</code></td>
<td>Initial population of turtles.</td>
<td>200, 400, 600, 800, 1000</td>
</tr>
<tr class="even">
<td><code>max-metabolism</code></td>
<td>Maximum metabolism of turtles. Metabolism for each turtle is assigned randomly between 1 and this variable.</td>
<td>2, 4, 6, 8, 10</td>
</tr>
<tr class="odd">
<td><code>max-vision</code></td>
<td>Maximum vision of turtles. Vision for each turtle is assigned randomly between 1 and this variable.</td>
<td>2, 4, 6, 8, 10</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="reporters-of-performance" class="level3">
<h3 class="anchored" data-anchor-id="reporters-of-performance">Reporters of Performance</h3>
<p>We have observed the reporters in <a href="#tbl-reporters">Table&nbsp;2</a> to measure the performance.</p>
<div id="tbl-reporters" class="anchored">
<table class="table">
<caption>Table&nbsp;2: Observatory statistics reported by the models</caption>
<colgroup>
<col style="width: 30%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Reporter</th>
<th style="text-align: left;">Explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Survival Rate of Turtles</td>
<td style="text-align: left;">Defined as the percentage of turtles alive at the natural state (Sugarscape 2), or the percentage of turtles who survived from starvation until their death by age (Sugarscape 3)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Gini Index</td>
<td style="text-align: left;">Cumulative proportion of wealth compared to the population, defined as the ratio of area under the Lorenz curve compared to perfect equality, as implemented in <span class="citation" data-cites="li2009a">Li and Wilensky (<a href="#ref-li2009a" role="doc-biblioref">2009b</a>)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Population at natural age</td>
<td style="text-align: left;">Population of turtles at the natural state. The survival rate is the ratio of this value divided by the initial population.</td>
</tr>
</tbody>
</table>
</div>
<p>Considering the warm-up period, observations were made at the natural state defined in <a href="#tbl-naturalstate">Table&nbsp;3</a>.</p>
<div id="tbl-naturalstate" class="anchored">
<table class="table">
<caption>Table&nbsp;3: Definitions of natural state for each model</caption>
<colgroup>
<col style="width: 20%">
<col style="width: 80%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Definition of natural state</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sugarscape 2</td>
<td>100 ticks after the last death of turtle</td>
</tr>
<tr class="even">
<td>Sugarscape 3</td>
<td>Observation window of 2 to 5 maximum lifespan lengths (100 ticks) after start,for survival rates, or 5 maximum lifespan lengths for other measurements</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="comparison-between-models" class="level3">
<h3 class="anchored" data-anchor-id="comparison-between-models">Comparison Between Models</h3>
<p>The comparison between models are done on the basis of population at the natural state. The Sugarscape 2 model has less turtles than the initial state, while the Sugarscape 3 model has constant population.</p>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<section id="survival-rate" class="level3">
<h3 class="anchored" data-anchor-id="survival-rate">Survival Rate</h3>
<p>The observed survival rates are shown in <a href="#fig-survivalrate">Figure&nbsp;1</a>.</p>
<div id="fig-survivalrate" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="image/r_survival_rate_combined.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Comparison of survival rates of the models. Higher survival rates are achieved by lower maximum metabolism, higher maximum vision, and lower population. A similar value is observed between the two models. A larger variance was observed for the Sugarscape 2 model, and in conditions with smaller population.</figcaption>
</figure>
</div>
<p>A significant drop of survival rate is observed for maximum metabolism of 6 and above. Since the maximum amount of sugar supplied by a patch in Sugarscape is 4, all turtles with metabolism over 4 die before the natural state.</p>
</section>
<section id="gini-index" class="level3">
<h3 class="anchored" data-anchor-id="gini-index">Gini Index</h3>
<p>The Gini Index for each simulation is shown in <a href="#fig-giniindex">Figure&nbsp;2</a>:</p>
<div id="fig-giniindex" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="image/r_gini_index_combined.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Comparison of the Gini Index of the models. Higher maximum metabolism and higher maximum vision results in a high Gini Index. Overall, the Sugarscape 3 model tends to have a higher Gini Index compared to the Sugarscape 2 model. The variance is higher when there is a smaller population.</figcaption>
</figure>
</div>
<p>The Sugarscape 3 model results in a higher Gini Index in general and is less affected by the population of turtles. A distinctive N-shaped pattern in accordance with population change, most apparent in conditions with high vision and moderate metabolism range, as shown in <a href="#fig-s2giniindex">Figure&nbsp;3</a>.</p>
<div id="fig-s2giniindex" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="image/r_s2_mvp_gini_filtered.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;3: Gini Index for Sugascape 2 model with <code>max-vision</code> = 10 and <code>max-metabolism</code> = 4.</figcaption>
</figure>
</div>
</section>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<section id="gini-index-1" class="level3">
<h3 class="anchored" data-anchor-id="gini-index-1">Gini Index</h3>
<section id="relationship-with-population" class="level4">
<h4 class="anchored" data-anchor-id="relationship-with-population">Relationship with Population</h4>
<p>An N-shaped pattern was observed for the relationship between the population and the Gini Index, as illustrated in <a href="#fig-s2giniindex">Figure&nbsp;3</a>. To identify the reason behind this phenomenon, we analysed the behaviour of wealth distribution of a typical generated by each variant. Snapshots and the wealth distribution at the natural state for different initial populations are shown in <a href="#fig-snapshot">Figure&nbsp;4</a>. The net wealth gained per tick is the amount of sugar for each turtle divided by the ticks passed, corresponding to the average difference between the collected sugar and metabolism per tick.</p>
<div id="fig-snapshot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="image/wealth_dist_graphs.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;4: Snapshot of natural state (left) and the histogram of wealth distribution (right) for models with different initial population (<code>max-vision</code> = 10 and <code>max-metabolism</code> = 4). The range was divided into 10 bins to create the histogram, and was plotted according to the net wealth gained per tick.</figcaption>
</figure>
</div>
<p>Distinct groups in the wealth distribution can be observed for all 4 simulations. The discrete distribution of metabolism and the steady sugar availability for each turtle may be causing this situation.</p>
<p>The model with initial population of 100 has most of the turtles clustered in the highly-supplying areas, allowing a larger income of sugar. This is confirmed by having the largest maximum net wealth gained per tick among the models.</p>
<p>The second model has 3 distinct groups, each clustered around 0, 1 and 2. This can be explained as turtles are having a steady income of 1, 2 or 3, but no longer having access to a steady income of 4 seen in the first model.</p>
<p>The third model shows a similar pattern, with a slightly lower net wealth gained per tick value for the whole population and a significantly smaller population of the group clustered around 0. Each turtle had a slightly smaller income, and this had a fatal impact on the ‘poorest’ group, reducing population. The improvement in the Gini Index was a result of this starvation, not a result of equal distribution of sugar.</p>
<p>The final model sees a decrease of the net wealth of groups in general, and the groups spreading out. The competition has made it difficult to gain a steady (integer) amount of income, leading to a decline in the income. The Gini Index has increased because the same absolute difference now has a different ratio, making the poorer group having less share of the total wealth.</p>
<p>In conclusion, the segregation into distinct groups and starvation of poorest groups may be causing the varying Gini Index and the survival rate resulting in the ‘N-shaped’ pattern observed in the scatter plot.</p>
</section>
<section id="considering-reproduction" class="level4">
<h4 class="anchored" data-anchor-id="considering-reproduction">Considering Reproduction</h4>
<p>The introduction of reproduction in the Sugarscape 3 model has caused the Gini Index to increase, indicating higher inequality (<a href="#fig-giniindex">Figure&nbsp;2</a>). This result contradicts our hypothesis, where we have predicted the ‘resetting’ evens out the distribution of wealth.</p>
<div id="fig-s3wealth" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="image/s3_wealth_skewed.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;5: Distribution of wealth in a Sugarscape 3 model at the natural state. <code>max-vision</code> = 6, <code>max-metabolism</code> = 4</figcaption>
</figure>
</div>
<p>The wealth distribution for the Sugarscape 3 model is negatively skewed, as shown in <a href="#fig-s3wealth">Figure&nbsp;5</a>. The constant supply of turtles in unsurvivable areas with low sugar supply contributes to keeping a steady amount of poor population, while this group cannot survive until the natural state in the Sugarscape 2 model. The existence of the poor group is the cause of a higher Gini Index.</p>
</section>
</section>
<section id="survival-rate-1" class="level3">
<h3 class="anchored" data-anchor-id="survival-rate-1">Survival Rate</h3>
<p>The 2 models have a similar survival rate when the final population is similar, suggesting a similar situation of competition regardless of their differences. As population increases, there is an initial steep drop, followed by a relatively flat segment where the survival rate is steady.</p>
<p>This can also be explained through the observations of <a href="#fig-snapshot">Figure&nbsp;4</a>. The initial drop is explained by the difference between the second and third model, where the ‘poorest’ group can no longer survive. The relatively flat area that follows is illustrated between the third and the fourth model, where the average income decreases but no significant population groups starve.</p>
<div id="fig-s2ginisurvival" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="image/r_s2_mvp_gini_survival.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;6: The relationship between the survival rate of turtles and the Gini Index for the Sugarscape 2 model.</figcaption>
</figure>
</div>
<p>The ‘N-shape’ of this graph is constructed through two patterns:</p>
<ol type="1">
<li>survival rate does not change significantly while the Gini Index increases</li>
<li>the survival rate and the Gini Index both drop</li>
</ol>
<p>The former may be caused by the ‘left-shift’ of the wealth distribution histogram observed between the third and fourth model in <a href="#fig-snapshot">Figure&nbsp;4</a>, while the latter may be caused by the poorest group forced into starvation.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>We have observed the impact of population and characteristics of turtles on the Gini Index and the survival rate of the Sugarscape models. These are both essential parameters when measuring the equality of wealth distribution. Our analysis has revealed that an improvement in the Gini Index may be a result of poor groups starving, thus excluded from calculation. Further development of the Sugarscape 3 model for different reproduction rules provides room for potential future research. By placing newborn turtles in locations in relationship to the parent, instead of a random distribution, may enable us to reflect the real-world parameters of parental influence and inheritance.</p>
<hr>
<p>Word count: 1,499 words.</p>
<p>The code for this report is available on <a href="https://github.com/sokimura39/ABM_assessment">GitHub</a>.</p>
<div style="page-break-after: always;"></div>
</section>
<section id="appendix" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="appendix">Appendix</h2>
<p>The reporters added to the model are the Gini Index and the survival rate.</p>
<section id="gini-index-2" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="gini-index-2">Gini Index</h3>
<p>The <strong>Gini Index</strong> shows the distribution of wealth among the population, where 0 shows complete inequality and 1 showing complete equality.</p>
<p>The implementation was done by the following function, inherited from the Sugarscape 3 model <span class="citation" data-cites="li2009a">(<a href="#ref-li2009a" role="doc-biblioref">Li and Wilensky, 2009b</a>)</span> with minor changes.</p>
<pre class="netlogo"><code>to update-lorenz-and-gini ; turtle context
  let num-people count turtles
  let sorted-wealths sort [sugar] of turtles
  let total-wealth sum sorted-wealths
  let wealth-sum-so-far 0
  let index 0
  set gini-index-reserve 0
  set lorenz-points []
  repeat num-people [
    set wealth-sum-so-far (
      wealth-sum-so-far + item index sorted-wealths
    )
    set lorenz-points (
      lput ((wealth-sum-so-far / total-wealth) * 100) lorenz-points
    )
    set index (index + 1)
    set gini-index-reserve
      gini-index-reserve +
      (index / num-people) -
      (wealth-sum-so-far / total-wealth)
  ]
  set gini-index ((gini-index-reserve / count turtles) * 2)
end</code></pre>
</section>
<section id="survival-rate-2" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="survival-rate-2">Survival Rate</h3>
<p>The <strong>survival rate</strong> is the ratio of turtles who have not starved to death. In the Sugarscape 2 model this is the percentage of initial turtles surviving at the natural state, and is reported by the following line of code in the <code>go</code> procedure.</p>
<pre class="netlogo"><code>  ; Sugarscape 2 model
  set survival-rate ((count turtles) / initial-population)</code></pre>
<p>For the Sugarscape 3 model where turtles die when reaching the maximum age, the survival rate is the ratio of turtles who have reached their maximum age without starving. In order to omit the warm-up period, the observation was made for the turtles who died between 2 and 5 maximum age lengths (100 ticks) after the start of the model.</p>
<p>This is achieved by setting 2 global variables to count the total deaths and those who died of starvation, and executing the following code within the <code>go</code> procedure.</p>
<pre class="netlogo"><code>  ; Sugarscape 3 model
  ask turtles [
    ;; check if cause of death is natural or of starvation
    if sugar &lt;= 0 or age &gt; max-age [
      set dead-pop (dead-pop + 1)
      if sugar &lt;= 0
      [ set starved-pop (starved-pop + 1) ]
      hatch 1 [ turtle-setup ]
      die
    ]
    run visualization
  ]

  ;; reset the starved ratio after 2 max ages have passed
  if ticks &lt;= (max-max-age * 2)
  [
    set starved-pop 0
    set dead-pop 0
  ]

  ;; calculate starved ratio, if none dead yet rate is 1
  carefully
  [ set survival-rate ( 1 - ( starved-pop / dead-pop ) ) ]
  [ set survival-rate 1 ]</code></pre>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="references" class="level2 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" role="list">
<div id="ref-epstein1996a" class="csl-entry" role="listitem">
Epstein, J. M. and Axtell, R. L. (1996) <em>Growing <span>Artificial Societies</span>: <span>Social Science</span> from the <span>Bottom Up</span></em>. <span>The MIT Press</span>. doi: <a href="https://doi.org/10.7551/mitpress/3374.001.0001">10.7551/mitpress/3374.001.0001</a>.
</div>
<div id="ref-li2009" class="csl-entry" role="listitem">
Li, J. and Wilensky, U. (2009a) <span>“<span>NetLogo Models Library</span>: <span>Sugarscape</span> 2 <span>Constant Growback</span>.”</span> <span>Evanston, IL.</span>: Center for Connected Learning and Computer-Based Modeling, Northwestern University.
</div>
<div id="ref-li2009a" class="csl-entry" role="listitem">
Li, J. and Wilensky, U. (2009b) <span>“<span>NetLogo Models Library</span>: <span>Sugarscape</span> 3 <span>Wealth Distribution</span>.”</span> <span>Evanston, IL.</span>: Center for Connected Learning and Computer-Based Modeling, Northwestern University.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>